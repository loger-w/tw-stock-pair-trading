# 台股雙刀戰法分析系統 - 開發需求規格書

## 一、專案背景

本系統為「配對交易」分析工具，專門用於台股同族群股票的套利分析。

**核心邏輯：** 當同族群的兩檔股票因短期事件產生價差偏離時，放空相對強勢股、做多相對弱勢股，等待價差收斂後獲利。

**主要應用場景：** 記憶體族群、AI 族群等熱門題材股在事件驅動下的短期套利機會。

---

## 二、產品定義

### 目標用戶
- 個人使用及少數朋友
- 具備配對交易基礎知識的投資者

### 使用情境
- 盤中：即時查看配對套利機會
- 盤後：複盤分析與部位規劃
- 資料於系統啟動時載入，不自動定時更新

### 市場定位
- 台灣市場目前尚無免費的配對交易分析工具
- 填補散戶在配對交易分析工具上的缺口

### 成功指標
- 以實單交易驗證策略有效性

---

## 三、核心功能模組

### 【模組 A】股票族群設定（支援多組資料）

#### A-1. 功能說明
- 側邊欄提供群組管理功能，使用者可新增、刪除群組
- 輸入群組名稱後，點擊「新增」按鈕加入清單
- 清單顯示：群組名稱 + 刪除按鈕，群組名稱下方顯示該群組內的股票代號與名稱
- 群組圖示：使用 folder icon（樣式待定）
- 選擇群組後，右側主區塊顯示該群組名稱及其股票清單

#### A-2. 限制條件
- 每個群組最多 **5 檔**股票
- 需設定 **2 檔以上**股票才能啟用計算按鈕
- 禁止加入重複股票（同一群組內）
- 股票代號不存在時，拒絕輸入並顯示 Toast 提示「不存在的股票代號」

#### A-3. 介面示意
```
┌─────────────────────────────────────────────┐
│ 輸入群組名稱： [    記憶體    ] [+ 新增]      │
├─────────────────────────────────────────────┤
│  [] 60 天 [勾] 120 天 [] 180 天              │
│  分析期間：120天                             │
│                                             │
│  [folder icon] 記憶體  [✕]                  │
│                 - 2344 華邦電                │
│                 - 2408 南亞科                │
│                 - 2337 旺宏                  │
│                                             │
│  [folder icon] AI 族群 [✕]                  │
│                   ...                       │
└─────────────────────────────────────────────┘
```

#### A-4. 空狀態
- 若無任何群組，顯示引導提示：「請新增群組並加入股票代號」

---

### 【模組 B】配對總覽（重點功能）

#### B-1. 配對組合計算
- 系統自動產生所有可能的配對組合（**具方向性**）
- N 檔股票產生 **N×(N-1)** 組配對
- 範例：3 檔股票 → 6 組配對
  - 華邦電 vs 南亞科
  - 華邦電 vs 旺宏
  - 南亞科 vs 華邦電
  - 南亞科 vs 旺宏
  - 旺宏 vs 華邦電
  - 旺宏 vs 南亞科
- 5 檔股票 → 20 組配對（單一群組上限）

#### B-2. 歷史資料不足處理
- 若股票上市天數不足設定的分析期間（如 120 天），該股票**不參與計算**
- 介面顯示提示：「{股票代號} 歷史資料不足，已排除」

#### B-3. 新增股票功能
- 模組 B 頂部提供股票代號輸入欄位，支援快速新增股票至當前群組
- 輸入框支援自動補全（顯示股票名稱供確認）
- 點擊「新增」或按 Enter 鍵加入股票
- 新增後自動清空輸入框，便於連續新增

**限制條件：**
- 群組已達 5 檔上限時，輸入框設為 disabled 並顯示提示
- 重複股票代號拒絕加入，Toast 提示「此股票已存在」
- 無效股票代號拒絕加入，Toast 提示「不存在的股票代號」

#### B-4. 總覽畫面示意圖
```
┌─────────────────────────────────────────────────────────────────────────┐
│  台股雙刀戰法                                                            │
├─────────────────────────────────────────────────────────────────────────┤
│  記憶體                                                                  │
│                                                                         │
│  新增股票： [ 輸入股票代號 ] [+ 新增]                                     │
│                                                                         │
│  已加入股票：2344 華邦電、2408 南亞科、2337 旺宏（3/5）                    │
├─────────────────────────────────────────────────────────────────────────┤
│  [ ] 只顯示強烈訊號   [計算]                                              │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐ ┌─────────────────────┐  ┌─────────────────────┐│
│  │ 訊號超強             │ │ 訊號弱               │  │ 無訊號              ││
│  │ 空間 27% 同步率 85% │ │ 空間 8% 同步率 78%   │   │ 空間 3% 同步率 75% ││
│  │ 2344 華邦電 空      │ │ 2344 華邦電 空       │  │ 2408 南亞科         ││
│  │ 2408 南亞科 買      │ │ 2408 旺宏 買         │  │ 2344 華邦電        ││
│  └────────────────────┘  └─────────────────────┘  └────────────────────┘│
│   ...                                                                   │
└─────────────────────────────────────────────────────────────────────────┘
點擊任一配對卡片可展開詳細分析 ↓
```

#### B-5. 排序與篩選
- 預設依股票輸入順序排列，依序產生配對組合
- 每個群組上限 5 檔股票
- 可篩選：勾選「只顯示強烈訊號」過濾弱訊號配對
- **點擊「計算」按鈕後，方顯示訊號結果**

#### B-6. 訊號判斷邏輯（雙向）

**當套利空間為正值（當前價差比率 > 歷史均值）：**
- 表示 A 相對 B 價格偏高 → 空 A 買 B

**當套利空間為負值（當前價差比率 < 歷史均值）：**
- 表示 A 相對 B 價格偏低 → 買 A 空 B

**訊號強度判斷表：**

| 套利空間絕對值 | Z-Score 絕對值 | 訊號等級 | 顯示顏色 |
|---------------|----------------|---------|----------|
| ≥20%          | ≥2.0           | 超強烈   | 🔴 紅色  |
| ≥15%          | ≥2.0           | 強烈     | 🔴 紅色  |
| ≥15%          | 1.5~2.0        | 中等     | 🟡 黃色  |
| ≥15%          | <1.5           | 弱       | ⚪ 灰色  |
| 10%~15%       | ≥2.0           | 中等     | 🟡 黃色  |
| 10%~15%       | 1.5~2.0        | 弱       | ⚪ 灰色  |
| <10%          | 任意           | 無       | ⚪ 灰色  |

**訊號文字顯示規則：**
```
若 套利空間 > 0：
  顯示「{股票A} 空 {股票B} 買」
若 套利空間 < 0：
  顯示「{股票A} 買 {股票B} 空」
若 |套利空間| ≥ 10% 但 |Z-Score| < 1.5：
  顯示「訊號弱」
```

---

### 【模組 C】單一配對詳細分析

當使用者點擊某一配對卡片時，展開詳細資訊：

#### C-1. 基礎資訊卡片
```
┌─────────────────────────────────────────────────────────────┐
│  📊 旺宏(2337) vs 威剛(3260) 詳細分析                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【今日股價】              【連動性分析】                    │
│  旺宏：58.30 元            漲跌同向率：85% ✅                │
│  威剛：257.50 元           相關係數：0.82 ✅                 │
│                                                             │
│  【價差比率統計】                                           │
│  ┌─────────────────┬─────────────────┐                     │
│  │ 歷史均值        │     0.1800      │                     │
│  │ 歷史標準差      │     0.0200      │                     │
│  │ 歷史最大值      │     0.2200      │                     │
│  │ 歷史最小值      │     0.1400      │                     │
│  │ 當前價差比率    │     0.2264      │                     │
│  └─────────────────┴─────────────────┘                     │
│                                                             │
│  【核心指標】                                               │
│  ┌─────────────────────────────────────┐                   │
│  │                                     │                   │
│  │   套利空間        Z-Score           │                   │
│  │   +27.0%          +2.30             │  ← 大字醒目顯示   │
│  │                                     │                   │
│  └─────────────────────────────────────┘                   │
│                                                             │
│  🔴 超強烈訊號：建議【空旺宏、買威剛】                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### C-2. 價差比率走勢圖
- X 軸：日期（過去 N 天）
- Y 軸：價差比率
- 顯示元素：
  - 藍色實線：每日價差比率
  - 橘色虛線：歷史均值（水平線）
  - 紅色區域：均值 + 2 倍標準差以上（超買區）
  - 綠色區域：均值 - 2 倍標準差以下（超賣區）
  - 標記點：今日位置（以大圓點標示）

#### C-3. 雙股價走勢對比圖
- 雙 Y 軸設計（左：股票 A，右：股票 B）
- 便於觀察兩檔股票的連動性與偏離情況

---

### 【模組 D】部位計算機

#### D-1. 功能說明
根據配對訊號自動計算建議部位，提供兩種模式：
1. **最小資金模式**：顯示執行此配對交易的最低資金門檻
2. **自訂資金模式**：使用者輸入總資金，計算建議張數

#### D-2. 介面示意
```
┌─────────────────────────────────────────────────────────────┐
│ 部位計算機                                                   │
├─────────────────────────────────────────────────────────────┤
│ 選擇配對： [旺宏 vs 威剛 ▼]                                   │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 【最小資金需求】                                         │ │
│ │                                                         │ │
│ │  最小交易資金：約 49 萬元                                 │ │
│ │  🟢 空 旺宏 4 張（233,200 元）                           │ │
│ │  🔴 買 威剛 1 張（257,500 元）                           │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ─────────────── 或自訂資金 ───────────────                   │
│                                                             │
│ 投入總資金： [    1,000,000    ] 元                          │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 【建議部位配置】                                         │ │
│ │                                                         │ │
│ │  🟢 空 旺宏 8 張（466,400 元）                           │ │
│ │  🔴 買 威剛 2 張（515,000 元）                           │ │
│ │                                                         │ │
│ │  實際使用資金：981,400 元                                │ │
│ │  部位價值差異：48,600 元（4.9%）                         │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

顏色說明：🟢 綠色 = 做空、🔴 紅色 = 做多（符合台股習慣）
```

#### D-3. 計算邏輯

**訊號方向自動判斷：**
- 依據該配對的套利空間正負值，自動決定多空方向

**最小資金計算：**
```
目標：找出最小整數張數組合，使多空部位價值接近

1. 計算股價比例：高價股股價 ÷ 低價股股價
2. 約化為最簡整數比（如 4.4:1 → 4:1 或 9:2）
3. 最小資金 = (高價股張數 × 高價股股價 + 低價股張數 × 低價股股價) × 1000

範例：
- 威剛 257.5 元、旺宏 58.3 元
- 比例：257.5 / 58.3 ≈ 4.4
- 最簡比：旺宏 4 張 : 威剛 1 張
- 最小資金：(1 × 257,500) + (4 × 58,300) = 490,700 元
```

**自訂資金計算：**
```
1. 每邊分配金額 = 總資金 ÷ 2
2. 高價股張數 = floor(每邊金額 ÷ 高價股股價 ÷ 1000)
3. 低價股張數 = 高價股張數 × 股價比例（取整數）
4. 計算實際使用資金與部位價值差異百分比
```

---

## 四、技術需求

### 資料來源（擇一）
1. **FinMind 開放資料**（推薦，免費）
   - API: https://api.finmindtrade.com/api/v4/data
   - 資料集：TaiwanStockPrice（含還原股價欄位）

2. **Yahoo Finance Taiwan**
   - 套件：yfinance
   - 代號格式：2337.TW
   - 注意：需自行處理還原股價

3. **證交所 OpenAPI**
   - 需自行計算還原股價

### 技術棧

| 類別 | 技術選擇 |
|------|----------|
| 語言 | TypeScript |
| 建構工具 | Vite |
| 框架 | React |
| UI 套件 | Tailwind CSS + Shadcn UI |
| 圖表 | ApexCharts 或 ECharts |
| 狀態管理 | React hooks（組件內）、Zustand（跨組件） |
| 資料請求 | TanStack Query（含快取機制） |
| 路由 | TanStack Router |
| 日期處理 | dayjs |
| 本地儲存 | IndexedDB（儲存群組與股票清單） |
| Toast 通知 | Sonner |
| 程式碼品質 | ESLint + Prettier |

### 計算邏輯
- 純前端計算（資料量較小，無需後端）
- 單一群組上限 5 檔股票、20 組配對，前端效能足以負荷
- TanStack Query 負責 API 快取，避免重複請求

---

## 五、UI/UX 設計要求

### 配色方案
```
主色調：深藍色 #1e3a5f（專業金融感）
次要色：淺藍色 #3b82f6
背景色：#f8fafc

訊號顏色：
- 強烈訊號：#dc2626（紅色）
- 中等訊號：#f59e0b（橘黃色）
- 弱/無訊號：#9ca3af（灰色）

漲跌顏色（台股習慣）：
- 漲/做多：#dc2626（紅色）
- 跌/做空：#16a34a（綠色）
```

### 頁面結構
```
┌──────────────────────────────────────────────────────────────────────────┐
│ Header：台股雙刀戰法分析系統                                               │
├──────────────────────────────────────────────────────────────────────────┤
│ 模組 A          │                                                        │
│ Sidebar         │┌────────────────────────────────────────────────────┐  │
│                 ││                                                    │  │
│                 ││  模組 B                                            │  │
│                 ││                                                    │  │
│                 ││                                                    │  │
│                 ││                                                    │  │
│                 │└────────────────────────────────────────────────────┘  │
│                 │                                                        │
│                 │┌─────────────────────────────────────────────────────┐ │
│                 ││                                                     │ │
│                 ││  模組 C                                              │ │
│                 ││  單一配對詳細分析（點擊配對卡片後展開）                 │ │
│                 ││  - 數據卡片                                          │ │
│                 ││  - 價差走勢圖                                        │ │
│                 ││  - 股價對比圖                                        │ │
│                 ││                                                     │ │
│                 │└─────────────────────────────────────────────────────┘ │
│                 │                                                        │
│                 │┌─────────────────────────────────────────────────────┐ │
│                 ││  模組 D：部位計算機                                  │ │
│                 │└─────────────────────────────────────────────────────┘ │
│                 │                                                        │
└──────────────────────────────────────────────────────────────────────────┘
```

### 響應式設計
- 桌面版（≥1024px）：左右並排佈局（目前僅支援桌面版）

### 互動體驗
- 股票代號輸入支援自動補全（顯示股票名稱）
- 圖表支援滑鼠懸停顯示詳細數值
- 關鍵指標（套利空間、訊號強度）以大字體醒目呈現

---

## 六、狀態處理設計

### Loading 狀態
- 資料載入中顯示 Loading UI（可使用 Shadcn Skeleton 或自製元件）
- 圖表載入使用圖表套件內建的 Loading 狀態（若有提供）

### Empty 狀態

| 情境 | 顯示內容 |
|------|----------|
| 無任何群組 | 「請新增群組並加入股票代號」 |
| 群組內無股票 | 「請加入至少 2 檔股票以進行配對分析」 |
| 股票數量不足 2 檔 | 計算按鈕設為 disabled，提示「需 2 檔以上股票」 |

### Error 狀態
- API 請求失敗：顯示 Toast 提示錯誤訊息
- 介面顯示「資料載入失敗」提示元件，附帶「重新載入」按鈕
- 股票代號不存在：Toast 提示「不存在的股票代號：{代號}」

---

## 七、資料流設計

### 資料儲存範圍

| 資料類型 | 儲存位置 | 說明 |
|----------|----------|------|
| 群組清單 | IndexedDB | 持久化儲存，重新開啟瀏覽器後仍保留 |
| 群組內股票 | IndexedDB | 持久化儲存 |
| 股價資料 | TanStack Query Cache | 記憶體快取，關閉分頁後清除 |
| 計算結果 | React State | 即時計算，不持久化 |

### 狀態管理範圍

| 狀態 | 管理方式 | 說明 |
|------|----------|------|
| 當前選中群組 | Zustand | 跨組件共享 |
| 分析期間設定 | Zustand | 跨組件共享 |
| 配對展開狀態 | React useState | 組件內部狀態 |
| 部位計算機輸入 | React useState | 組件內部狀態 |

### API 請求流程
```
1. 使用者選擇群組
2. 從 IndexedDB 取得群組內股票清單
3. 點擊「計算」按鈕
4. 對每檔股票發送 API 請求取得歷史股價（TanStack Query 處理快取）
5. 過濾歷史資料不足的股票
6. 前端計算所有配對指標
7. 渲染結果
```

---

## 八、Edge Cases 清單

| 情境 | 處理方式 |
|------|----------|
| 輸入不存在的股票代號 | Toast 提示「不存在的股票代號」，拒絕加入清單 |
| 重複加入相同股票 | Toast 提示「此股票已存在」，拒絕重複加入 |
| 群組內股票不足 2 檔 | 計算按鈕設為 disabled |
| 群組內股票超過 5 檔 | 禁止新增，Toast 提示「每個群組最多 5 檔股票」 |
| 股票歷史資料不足分析期間 | 排除該股票，顯示提示訊息 |
| 群組內僅 1 檔股票有足夠資料 | 顯示「有效股票不足，無法進行配對分析」 |
| API 請求失敗 | Toast 錯誤提示 + 重試按鈕 |
| API Rate Limit | Toast 提示「請求過於頻繁，請稍後再試」 |
| 網路斷線 | Toast 提示網路連線錯誤 |

---

## 九、進階功能（TO-DO，未來開發）

以下功能暫不實作，列為未來規劃：

- [ ] **預設族群快速載入**
  - 一鍵載入「記憶體族群」「AI 族群」等預設清單

- [ ] **歷史回測**
  - 顯示過去一年依此策略操作的績效
  - 勝率、平均報酬、最大虧損

- [ ] **推播通知**
  - 當追蹤配對的 Z-Score 突破 ±2 時發送通知
  - 支援 Line Notify 或 Telegram Bot

- [ ] **處置股監控**
  - 串接證交所處置股公告
  - 標示即將進入或離開處置的股票

---

## 十、名詞定義（供開發者參考）

| 名詞 | 定義 |
|------|------|
| 還原股價 | 已調整除權息影響的股價，用於計算真實報酬 |
| 價差比率 | 股票 A 還原股價 ÷ 股票 B 還原股價 |
| 套利空間 | (當前價差比率 ÷ 歷史均值) - 1，以百分比顯示 |
| Z-Score | (當前價差比率 - 歷史均值) ÷ 歷史標準差 |
| 漲跌同向率 | 兩股票同漲或同跌的天數佔總天數百分比 |
| 處置股 | 因交易異常被證交所限制交易方式的股票 |
| 配對交易 | 同時做多一檔、做空另一檔，賺取價差收斂的策略 |

---

## 十一、開發優先順序

### Phase 1（MVP）
- 模組 A：群組系統（含 IndexedDB 儲存）
- 模組 B：配對總覽（含新增股票功能、計算按鈕觸發機制）
- 基礎計算邏輯（套利空間、Z-Score、同向率）
- 狀態處理（Loading、Empty、Error）

### Phase 2
- 模組 C：單一配對詳細分析 + 圖表
- 模組 D：部位計算機（含最小資金計算、自訂資金計算）

### Phase 3（TO-DO）
- 進階功能逐步實作
