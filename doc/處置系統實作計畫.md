# 處置預警與監控系統 - 實作計畫

## 專案概述

為「台股雙刀戰法分析系統」新增第二個功能模組：「處置預警與監控系統」。

**核心功能：**
- 注意股票列表：顯示累計注意 1-2 次的股票，依風險等級顏色區分
- 處置股票列表：顯示已處置股票，含分盤間隔與出關日期
- 臨界價預測：針對累計 2 次的高風險股票，計算進處置臨界價格

**導航設計：**
- Sidebar 頂部加入 Tab 切換（雙刀戰法 / 處置系統）
- 處置系統頁面不需要 Sidebar 內容區，僅保留導航 Tab 與標題

**資料來源：**
- MVP 階段使用 Mock Data
- 後續串接證交所/櫃買中心公開資料（需後端代理）

---

## Phase 0：架構重構 ✅ 已完成

### 目標
將雙刀戰法相關程式碼移動到 `pairs` 子資料夾，為處置系統騰出獨立空間。

### 完成項目

#### 1. 建立資料夾結構
```
src/
├── hooks/pairs/           ✅ 已建立
├── services/pairs/        ✅ 已建立
├── lib/pairs/             ✅ 已建立
├── stores/pairs/          ✅ 已建立
├── types/pairs/           ✅ 已建立
├── hooks/disposal/        ✅ 已建立
├── services/disposal/     ✅ 已建立
├── lib/disposal/          ✅ 已建立
├── types/disposal/        ✅ 已建立
└── components/disposal/   ✅ 已建立
```

#### 2. 移動檔案
| 原路徑 | 新路徑 |
|--------|--------|
| `hooks/useStockGroups.ts` | `hooks/pairs/useStockGroups.ts` |
| `hooks/useStockPrices.ts` | `hooks/pairs/useStockPrices.ts` |
| `hooks/useStockSearch.ts` | `hooks/pairs/useStockSearch.ts` |
| `hooks/usePairCalculation.ts` | `hooks/pairs/usePairCalculation.ts` |
| `services/api.ts` | `services/pairs/api.ts` |
| `services/db.ts` | `services/pairs/db.ts` |
| `lib/calculations.ts` | `lib/pairs/calculations.ts` |
| `lib/signals.ts` | `lib/pairs/signals.ts` |
| `lib/constants.ts` | `lib/pairs/constants.ts` |
| `stores/appStore.ts` | `stores/pairs/appStore.ts` |
| `types/index.ts` | `types/pairs/index.ts` |

#### 3. 更新 Import 路徑
所有引用上述檔案的元件已更新 import 路徑：
- `@/hooks/useStockGroups` → `@/hooks/pairs/useStockGroups`
- `@/services/api` → `@/services/pairs/api`
- `@/lib/constants` → `@/lib/pairs/constants`
- `@/stores/appStore` → `@/stores/pairs/appStore`
- `@/types` → `@/types/pairs`
- 以此類推...

### 驗證
- [x] `npm run build` 編譯成功
- [x] `npm run dev` 開發伺服器正常運行
- [x] 雙刀戰法功能正常運作

---

## Phase 1：導航與路由 ✅ 已完成

### 目標
實現 Sidebar 頂部 Tab 切換，支援雙刀戰法與處置系統兩個頁面。

### 完成項目

#### 1. 建立 NavigationTabs 元件
**檔案：** `src/components/layout/NavigationTabs.tsx`

```tsx
// 已實作功能
- 兩個 Tab：「雙刀戰法」和「處置系統」
- 使用 TanStack Router 的 Link 元件
- 當前頁面 Tab 高亮顯示（border-b-2 + bg-accent/50）
- 支援鍵盤導航（ArrowLeft/ArrowRight 切換、tabIndex、aria-label、role="tablist"）
```

#### 2. 修改 Sidebar.tsx
**檔案：** `src/components/layout/Sidebar.tsx`

```tsx
// 已完成變更
- 頂部加入 NavigationTabs
- 使用 useLocation 判斷當前路由（無需從 __root.tsx 傳遞 props）
- 雙刀戰法頁面（/）：顯示完整 Sidebar（標題、CreateGroupDialog、PeriodSelector、GroupList）
- 處置系統頁面（/disposal）：僅顯示 NavigationTabs + 簡化標題（紅色主題）
```

#### 3. 新增處置系統路由
**檔案：** `src/routes/disposal.tsx`

```tsx
// 已完成內容
- 建立 /disposal 路由
- 渲染 DisposalOverview 元件（placeholder 狀態）
```

#### 4. 建立 DisposalOverview 元件
**檔案：** `src/components/disposal/DisposalOverview.tsx`

```tsx
// Placeholder 元件
- 顯示「處置預警系統」標題
- 提示「此功能正在開發中」
```

### 驗證
- [x] Tab 切換正常，URL 對應 `/` 和 `/disposal`
- [x] 雙刀戰法頁面顯示完整 Sidebar
- [x] 處置系統頁面僅顯示導航 Tab 和標題
- [x] `npm run build` 編譯成功

---

## Phase 2：型別與常數 ✅ 已完成

### 目標
建立處置系統所需的型別定義和常數。

### 完成項目

#### 1. 型別定義
**檔案：** `src/types/disposal/index.ts`

```typescript
// 已實作型別
- MarketType: 'TWSE' | 'TPEx'
- ThresholdType: '6d' | '30d'
- DisposalInterval: 5 | 20
- AttentionCount: 1 | 2
- AttentionStock: 注意股票介面（含 JSDoc 註解）
- DisposalStock: 處置股票介面
- DisposalApiResponse: API 回應介面
- ThresholdResult: 臨界價計算結果介面
```

#### 2. 常數定義
**檔案：** `src/lib/disposal/constants.ts`

```typescript
// 已實作常數
- DISPOSAL_COLORS: 顏色定義（attention1/attention2/disposal/primary）
- THRESHOLD_RATES: 漲幅門檻比率（TWSE/TPEx 的 day6/day30）
- DISPOSAL_QUERY_KEYS: TanStack Query 快取鍵
- STATUS_LABELS: 狀態標籤文字
- MARKET_LABELS: 市場類型標籤（上市/上櫃）
```

#### 3. Mock Data
**檔案：** `src/services/disposal/mockData.ts`

```typescript
// 已建立範例資料
- mockAttentionStocks: 5 筆注意股票（含 2 筆高風險）
- mockDisposalStocks: 4 筆處置股票（含 5 分盤和 20 分盤）
```

### 驗證
- [x] TypeScript 編譯無錯誤
- [x] 型別可正確匯入使用
- [x] `npm run build` 編譯成功

---

## Phase 3：處置系統 UI 元件 ✅ 已完成

### 目標
建立處置系統所有 UI 元件。

### 完成項目

#### 1. API 服務
**檔案：** `src/services/disposal/api.ts`
- fetchDisposalData：取得處置系統資料（Mock 版本，500ms 延遲）

#### 2. Hook
**檔案：** `src/hooks/disposal/useDisposalData.ts`
- useDisposalData：TanStack Query hook（5 分鐘 staleTime）

#### 3. UI 元件清單（全部已實作）

| 元件 | 檔案路徑 | 功能 |
|------|----------|------|
| StatusBadge | `components/disposal/StatusBadge.tsx` | 狀態標籤（注意/處置），支援 union type props |
| DataUpdateTime | `components/disposal/DataUpdateTime.tsx` | 資料更新時間顯示（YYYY/MM/DD HH:mm 格式） |
| AttentionStockCard | `components/disposal/AttentionStockCard.tsx` | 注意股票卡片，含臨界價警示 |
| DisposalStockCard | `components/disposal/DisposalStockCard.tsx` | 處置股票卡片，含出關倒數 |
| AttentionStockList | `components/disposal/AttentionStockList.tsx` | 注意股票列表（按風險排序） |
| DisposalStockList | `components/disposal/DisposalStockList.tsx` | 處置股票列表（按出關日排序） |
| DisposalOverview | `components/disposal/DisposalOverview.tsx` | 主頁面容器（含 Loading/Error 狀態） |

#### 4. 頁面功能
- 響應式兩欄佈局（lg 以上並排，以下垂直堆疊）
- Loading 狀態使用 Skeleton 骨架畫面
- Error 狀態顯示錯誤訊息 + 重新載入按鈕
- 重新整理按鈕（右上角）
- 免責聲明（底部）

### 驗證
- [x] 頁面正確顯示兩欄卡片佈局
- [x] 注意股票依累計次數顏色區分（1次黃色、2次橘色）
- [x] 處置股票顯示分盤間隔和出關日期
- [x] Loading/Error 狀態正常顯示
- [x] `npm run build` 編譯成功

---

## Phase 4：臨界價計算 ✅ 已完成

### 目標
實作臨界價計算邏輯，針對累計 2 次的高風險股票顯示進處置臨界價格。

### 完成項目

#### 1. 計算邏輯
**檔案：** `src/lib/disposal/calculations.ts`

```typescript
// 已實作函式
- calculateThresholdPrice(marketType, priceT5, priceT29): 計算臨界價
- calculatePriceMargin(currentPrice, thresholdPrice): 計算漲幅空間
- isNearThreshold(currentPrice, thresholdPrice): 判斷是否接近臨界價（5%內）
```

#### 2. 計算 Hook
**檔案：** `src/hooks/disposal/useThresholdCalculation.ts`

```typescript
// 已實作功能
- 僅對 attentionCount === 2 且無 thresholdPrice 的股票啟用查詢
- 若資料已有 thresholdPrice 直接返回（不重新計算）
- Mock 版本的歷史價格取得（未來串接真實 API 時替換）
- 10 分鐘 staleTime 快取
```

#### 3. UI 整合（Phase 3 已完成）
在 `AttentionStockCard` 中：
- 僅 `attentionCount === 2` 時顯示臨界價
- 顯示格式：「明日收盤 > XXX 元即進處置」
- 橘色背景警示區塊 + AlertTriangle 圖示

### 驗證
- [x] 累計 2 次的股票正確顯示臨界價
- [x] 臨界價計算結果符合預期
- [x] `npm run build` 編譯成功

---

## Phase 5：狀態處理 ✅ 已完成（於 Phase 3 實作）

### 目標
實作 Loading、Empty、Error 狀態的 UI 處理。

### 完成項目

#### 1. Loading 狀態
- 使用 Shadcn Skeleton 元件
- 顯示兩欄卡片的骨架畫面（DisposalOverview.tsx）

#### 2. Empty 狀態
| 區塊 | 顯示內容 |
|------|----------|
| 注意股票（左側） | 「目前無注意股票」（AttentionStockList.tsx） |
| 處置中（右側） | 「目前無處置股票」（DisposalStockList.tsx） |

#### 3. Error 狀態
- 介面顯示「資料載入失敗」+ 錯誤圖示
- 「重新載入」按鈕（帶 loading 動畫）
- 實作於 DisposalOverview.tsx

### 驗證
- [x] Loading 狀態正確顯示
- [x] Empty 狀態正確顯示
- [x] Error 狀態正確顯示並可重試

---

## 最終驗證清單

### 功能驗證
- [x] Tab 切換正常，URL 對應 `/` 和 `/disposal`
- [x] 雙刀戰法功能未被破壞
- [x] 處置系統顯示 Mock 注意股票列表
- [x] 處置系統顯示 Mock 處置股票列表
- [x] 高風險股票（2次）顯示臨界價
- [x] Loading/Empty/Error 狀態正常

### 建置驗證
```bash
npm run build   # TypeScript 編譯 + Vite 打包
npm run lint    # ESLint 檢查
npm run dev     # 開發伺服器測試
```

---

## 後續規劃（TO-DO）

### 真實 API 串接
- 建立 Vercel Serverless Functions 代理
- 爬取證交所/櫃買中心公開資料
- 處理 CORS 問題

### 進階功能
- 推播通知（Line Notify / Telegram Bot）
- 歷史處置紀錄查詢
- 與雙刀戰法深度整合
- 60日/90日臨界價計算
