# 台股處置預警與監控系統 - 開發需求規格書

## 一、專案背景

本系統為「市場風險狀態」監控工具，專門用於追蹤台股個股是否即將進入、或已經處於「注意股票」或「處置股票」狀態。

**核心價值：**
- **避險（多方）：** 避免買入即將被「關禁閉」（處置）導致流動性喪失的股票
- **投機（空方）：** 尋找流動性即將受限、或處置出關後的劇烈波動機會
- **規則透明化：** 將複雜的證交所/櫃買中心條文轉化為視覺化的風險儀表板

**專案定位：** 整合至「台股雙刀戰法分析系統」作為獨立分頁模組

---

## 二、產品定義

### 目標用戶
- 短線當沖客（需關注當沖比與處置限制）
- 波段交易者（需關注流動性風險）
- 既有「雙刀戰法系統」的使用者（作為輔助模組）

### 使用情境
- 盤後分析：查看當日最新的注意股票與處置股票清單
- 處置預測：針對高風險股票，預測明日進處置的臨界價格

### 成功指標
- 準確顯示當日注意股票與處置股票清單
- 正確計算「明日進處置」的臨界價格（涵蓋 80% 情境）

---

## 三、核心功能模組

### 【模組 A】注意股票列表（左側區塊）

#### A-1. 功能說明
- 顯示所有「累計注意 1 次以上」的股票清單
- 依累計次數用顏色區分風險等級
- 針對「累計 2 次」的股票，顯示預測的進處置臨界價格

#### A-2. 卡片資訊架構

**累計 1 次（黃色）：**
```
┌──────────────────────────────────────────────┐
│  2330 台積電 (上市)                          │
│  狀態：🟡 注意股票                           │
│  累計注意：1 次 / 3 次                       │
│  觸發原因：近6日累積漲幅過高                 │
└──────────────────────────────────────────────┘
```

**累計 2 次（橘色，高風險）：**
```
┌──────────────────────────────────────────────┐
│  3260 威剛 (上櫃)                            │
│  狀態：🟠 注意股票（高風險）                  │
│  累計注意：2 次 / 3 次（差 1 次進處置）       │
│  觸發原因：近6日累積漲幅過高                 │
│  ⚠️ 明日收盤超過 320 元即進處置              │
└──────────────────────────────────────────────┘
```

#### A-3. 顏色規則

| 累計次數 | 顏色 | 風險等級 |
|---------|------|----------|
| 1 次 | 🟡 黃色 `#f59e0b` | 一般注意 |
| 2 次 | 🟠 橘色 `#f97316` | 高風險（即將進處置） |

#### A-4. 空狀態
- 若無任何注意股票，顯示：「目前無注意股票」

---

### 【模組 B】處置中列表（右側區塊）

#### B-1. 功能說明
- 顯示所有「已進入處置」的股票清單
- 顯示分盤交易間隔（5分/20分）
- 顯示預計出關日期

#### B-2. 卡片資訊架構
```
┌──────────────────────────────────────────────┐
│  xxxx     (上市)                            │
│  狀態：🔴 處置中（5分盤）                    │
│  預計出關：2026/02/20                        │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│  yyyy      (上櫃)                            │
│  狀態：🔴 處置中（20分盤）                   │
│  預計出關：2026/02/25                        │
└──────────────────────────────────────────────┘
```

#### B-3. 空狀態
- 若無任何處置股票，顯示：「目前無處置股票」

---

### 【模組 C】處置預測計算（內建於模組 A）

#### C-1. 功能說明
針對「累計注意 2 次」的高風險股票，自動計算並顯示「明日進處置」的臨界價格。

#### C-2. 計算邏輯（涵蓋 80% 情境）

**觸發條件與臨界價計算：**

| 條件 | 基準日 | 門檻（上市） | 門檻（上櫃） | 臨界價公式 |
|------|--------|-------------|-------------|-----------|
| 6日累積漲幅 | T-5 日收盤價 | 25% | 30% | `基準價 × 1.25 或 1.30` |
| 30日累積漲幅 | T-29 日收盤價 | 100% | 100% | `基準價 × 2.00` |

**計算流程：**
```
1. 確認股票累計注意次數 = 2
2. 取得歷史收盤價：
   - Price_T5 = 5 個交易日前的收盤價
   - Price_T29 = 29 個交易日前的收盤價
3. 計算臨界價：
   - Limit_6d = Price_T5 × 1.25（上市）或 1.30（上櫃）
   - Limit_30d = Price_T29 × 2.00
4. 取較低者作為警示價格：
   - Threshold = min(Limit_6d, Limit_30d)
5. 顯示：「明日收盤超過 {Threshold} 元即進處置」
```

#### C-3. 計算範例
```
股票：威剛 (3260，上櫃)
累計注意：2 次

歷史數據：
- T-5 日收盤價：246 元
- T-29 日收盤價：180 元

計算：
- Limit_6d = 246 × 1.30 = 319.8 元
- Limit_30d = 180 × 2.00 = 360 元
- Threshold = min(319.8, 360) = 319.8 元

顯示：「明日收盤超過 320 元即進處置」
```

#### C-4. 注意事項
- 本計算僅涵蓋「價格異常」觸發條件（約 80% 情境）
- 「週轉率/成交量異常」等條件與價格無關，無法用此方式預測
- 建議在卡片上加註：「僅供參考，實際以證交所公告為準」

---

## 四、技術需求

### 資料來源

**上市（TWSE）：**

| 資料類型 | 來源網址 | 格式 |
|---------|---------|------|
| 注意股票 | https://www.twse.com.tw/zh/announcement/notice.html | CSV/JSON |
| 處置股票 | https://www.twse.com.tw/zh/announcement/punish.html | CSV/JSON |

**上櫃（TPEx）：**

| 資料類型 | 來源網址 | 格式 |
|---------|---------|------|
| 注意股票 | https://www.tpex.org.tw/web/bulletin/attention_information/trading_attention_information.php | CSV/JSON |
| 處置股票 | https://www.tpex.org.tw/web/bulletin/disposal_information/disposal_information.php | CSV/JSON |

### 必要資料欄位

| 欄位名稱 | 用途 | 來源 |
|---------|------|------|
| 股票代號 | 識別股票 | API |
| 股票名稱 | 顯示用 | API |
| 市場類型 | 區分上市/上櫃（門檻不同） | API |
| 累計注意次數 | 判斷風險等級 | API 或計算 |
| 觸發原因 | 顯示注意原因 | API |
| 處置期間 | 計算出關日 | API |
| 分盤間隔 | 顯示 5分/20分 | API |
| 歷史收盤價 | 計算臨界價 | API |

### 技術棧（沿用雙刀戰法系統）

| 類別 | 技術選擇 |
|------|----------|
| 語言 | TypeScript |
| 建構工具 | Vite |
| 框架 | React |
| UI 套件 | Tailwind CSS + Shadcn UI |
| 狀態管理 | React hooks（組件內）、Zustand（跨組件） |
| 資料請求 | TanStack Query（含快取機制） |
| 路由 | TanStack Router |
| 日期處理 | dayjs |
| Toast 通知 | Sonner |
| 程式碼品質 | ESLint + Prettier |

---

## 五、UI/UX 設計要求

### 配色方案
```
主色調：深藍色 #1e3a5f（專業金融感）
次要色：淺藍色 #3b82f6
背景色：#f8fafc

狀態顏色：
- 注意（1次）：#f59e0b（黃色）
- 注意（2次）：#f97316（橘色）
- 處置中：#dc2626（紅色）
```

### 頁面結構
```
┌──────────────────────────────────────────────────────────────────────────┐
│  資料更新：2026/02/05 17:30                                              │
├──────────────────────────────────────────────────────────────────────────┤
│                │                                                        │
│ Sidebar 已存在  │                                                       │
│ (雙刀系統)      │                                                        │
│                │  【注意股票】             【處置中】                    │
│                │                                                       │
│                │  ┌──────────────┐        ┌──────────────┐             │
│                │  │ 🟠 3260 威剛 │        │ 🔴 2337 旺宏│              │
│                │  │ 2次/3次     │          5分盤         │             │
│                │  │ ⚠️ >320進處置│        │ 出關:02/20   │             │
│                │  └──────────────┘        └──────────────┘             │
│                │                                                       │
│                │  ┌──────────────┐        ┌──────────────┐             │
│                │  │ 🟡 2330 台積 │        │ 🔴 8358 金居 │             │
│                │  │ 1次/3次     │          20分盤        │             │
│                │  └──────────────┘        │ 出關:02/25   │             │
│                │         ...              └──────────────┘             │
│                │                              ...                      │
│                │                                                       │
│                │                 (外部統一滾動)                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### 互動設計
- **無點擊展開**：卡片為純展示，不需點擊互動
- **無篩選排序**：直接顯示所有資料
- **無搜尋功能**：不提供股票搜尋
- **滾動處理**：當卡片數量超過可視區域時，外部滾動

### 響應式設計
- 桌面版（≥1024px）：左右並排佈局（目前僅支援桌面版）

---

## 六、狀態處理設計

### 資料更新機制
- **更新頻率**：盤後更新一次
- **更新時間顯示**：頁面頂部顯示「資料更新：YYYY/MM/DD HH:mm」（系統抓取時間）

### Loading 狀態
- 資料載入中顯示 Loading UI（可使用 Shadcn Skeleton）

### Empty 狀態

| 區塊 | 顯示內容 |
|------|----------|
| 注意股票（左側） | 「目前無注意股票」 |
| 處置中（右側） | 「目前無處置股票」 |

### Error 狀態
- API 請求失敗：顯示 Toast 提示錯誤訊息
- 介面顯示「資料載入失敗」提示元件，附帶「重新載入」按鈕

---

## 七、資料流設計

### 資料儲存範圍

| 資料類型 | 儲存位置 | 說明 |
|----------|----------|------|
| 注意/處置股票清單 | TanStack Query Cache | 記憶體快取，盤後更新 |
| 歷史收盤價 | TanStack Query Cache | 用於計算臨界價 |
| 系統抓取時間 | React State | 顯示更新時間 |

### API 請求流程
```
1. 頁面載入時，發送 API 請求取得：
   - 上市注意股票清單
   - 上櫃注意股票清單
   - 上市處置股票清單
   - 上櫃處置股票清單
2. 合併上市/上櫃資料
3. 針對累計 2 次的股票，額外請求歷史收盤價
4. 計算臨界價格
5. 渲染左右兩欄卡片
6. 記錄系統抓取時間
```

---

## 八、Edge Cases 清單

| 情境 | 處理方式 |
|------|----------|
| API 請求失敗 | Toast 錯誤提示 + 重試按鈕 |
| 網路斷線 | Toast 提示網路連線錯誤 |
| 歷史資料不足（新股） | 無法計算臨界價，顯示「資料不足，無法預測」 |
| 注意股票同時觸發多條件 | 顯示主要觸發原因（依 API 回傳） |
| 處置延長 | 依 API 回傳的最新出關日顯示 |
| 除權息影響 | 提示使用者注意除權息可能影響計算準確度 |

---

## 九、進階功能（TO-DO，未來開發）

以下功能暫不實作，列為未來規劃：

- [ ] **推播通知**
  - 當追蹤股票累積注意次數達 2 次時發送預警通知
  - 支援 Line Notify 或 Telegram Bot

- [ ] **歷史處置紀錄**
  - 查詢個股過去的處置歷史
  - 分析處置前後的股價走勢

- [ ] **與雙刀戰法深度整合**
  - 在配對分析中標示處置風險
  - 自動排除處置股票的配對組合

- [ ] **60日/90日臨界價計算**
  - 擴充預測邏輯，涵蓋更多觸發條件

- [ ] **週轉率/成交量異常預警**
  - 針對非價格因素的觸發條件提供監控

---

## 十、名詞定義（供開發者參考）

| 名詞 | 定義 |
|------|------|
| 注意股票 | 因交易異常（價格、成交量、當沖比等）被證交所/櫃買中心列為關注對象的股票 |
| 處置股票 | 因持續異常被限制交易方式（如分盤交易、預收款券）的股票 |
| 累計注意次數 | 最近 10 個交易日內被列為注意股票的天數，達 3 次即進入處置 |
| 臨界價格 | 反推計算出的「明日進處置」門檻價格 |
| 6日累積漲幅 | 最近 6 個交易日的收盤價累積漲跌幅 |
| 30日累積漲幅 | 最近 30 個交易日的收盤價累積漲跌幅 |
| 分盤交易 | 處置期間的交易限制，每 5 分鐘或 20 分鐘撮合一次 |
| 出關 | 處置期間結束，恢復正常交易 |
| T-5 日 | 包含當日的前第 6 個交易日（用於計算 6 日累積漲幅的基準日） |
| T-29 日 | 包含當日的前第 30 個交易日（用於計算 30 日累積漲幅的基準日） |

---

## 十一、開發優先順序

### Phase 1（MVP）
- 資料層：串接證交所/櫃買中心 API，取得注意/處置股票清單
- 模組 A：注意股票列表（左側），含顏色區分
- 模組 B：處置中列表（右側），含出關日期與分盤間隔
- 狀態處理（Loading、Empty、Error）
- 頁面整合至雙刀戰法系統作為獨立分頁

### Phase 2（預測功能）
- 模組 C：處置預測計算（6日、30日臨界價）
- 歷史收盤價 API 串接
- 臨界價格顯示於高風險卡片（累計 2 次）

### Phase 3（TO-DO）
- 進階功能逐步實作

